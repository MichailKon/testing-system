# Устройство инвокера

Инвокер принимает от мастера джобы, каждый джоб может быть 2 видов:
- Компиляция
- Тестирование

Инвокер в некотором порядке выполняет эти джобы и высылает мастеру инфу про джоб при завершении обработки.

При любой коммуникации с мастером инвокер посылает ему 2 параметра:
1. Количество новых джобов, которые он готов принять
2. Список всех текущих джобов, которые он пока обрабатывает

*Тут нужно много написать про то, какие гарантии дает инвокер, но это надо обсудить всем вместе*

## Внутреннее устройство

Инвокер состоит из следующих компонент:
- Sandbox. Он отвечает за изоляцию всех процессов
- InvokerStorage. Это кеш над файлами из стораджа
- Compiler. Это класс, хранящий инфу про компиляторы.

В инвокере крутится несколько видов тредов:
- JobExecutor. К каждому такому треду привязан отдельный sandbox.
  Этот тред отвечает за подготовку к исполнению процессов джоба и за финальную обработку джоба.
  Количество JobExecutor может быть довольно большим, чем параллелизм инвокера.
- Runner. Этот тред отвечает только за выполнение джобов, уже подготовленных JobExecutor, количество раннеров равно параллелизму инвокера.

### Пайплайн обработки джоба

При появлении джоб попадает в очередь.
В очереди он ждет, когда освободится какой-нибудь JobExecutor и принимается им.

JobExecutor при приеме джоба сначала начинает подготавливать все для его исполнения. 
Это включает в себя подготовку сендбокса и подгрузку всех нужных ресурсов из стораджа.
Когда джоба полностью готова к исполнению то она закидывается в очередь на Runner. 
Далее JobExecutor будет ждать, когда Runner запустит процессы джоба.

Runner по очереди достает все джобы из своей очереди, и запускает уже подготовленный для запуска джоб.
Соответственно одновременно запущено может быть не больше джобов, чем число раннеров, хоть и одновременно сильно больше джобов могут находиться в обработке.

Когда Runner завершает выполнение джоба, то его JobExecutor просыпается и начинает финализировать выполнение джоба. 
Он посылает результат исполнения на сторадж и инвокер. 
Только когда выполнение джоба закончено, то JobExecutor сбрасывает сендбокс и берет следующих джоб из очереди.

Устройство довольно сложное, но зато мы можем одновременно обрабатывать очень много джобов, и например если для какого-то джоба нужны тяжелые ресурсы, то просто его JobExecutor будет стоять, но другие джобы смогут выполниться на раннерах не ждя честной очереди.

